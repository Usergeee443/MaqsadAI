<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HamyonAI - Moliyaviy Hisobotlar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .balance-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .balance-amount {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .balance-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--tg-theme-accent-text-color, #007bff);
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #6c757d);
            margin-top: 5px;
        }
        
        .chart-container {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .transactions-list {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 15px;
            padding: 20px;
        }
        
        .transactions-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e9ecef);
        }
        
        .transaction-item:last-child {
            border-bottom: none;
        }
        
        .transaction-info {
            flex: 1;
        }
        
        .transaction-category {
            font-weight: bold;
            font-size: 14px;
        }
        
        .transaction-description {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #6c757d);
            margin-top: 2px;
        }
        
        .transaction-amount {
            font-weight: bold;
            font-size: 14px;
        }
        
        .amount-income {
            color: #28a745;
        }
        
        .amount-expense {
            color: #dc3545;
        }
        
        .amount-debt {
            color: #ffc107;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color, #6c757d);
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }
        
        .refresh-btn {
            background: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        
        .refresh-btn:active {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Moliyaviy Hisobotlar</h1>
        </div>
        
        <div id="loading" class="loading">
            üìä Ma'lumotlar yuklanmoqda...
        </div>
        
        <div id="content" style="display: none;">
            <div class="balance-card">
                <div class="balance-amount" id="balance-amount">0 so'm</div>
                <div class="balance-label">Jami balans</div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value amount-income" id="income-amount">0</div>
                    <div class="stat-label">üìà Kirim</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value amount-expense" id="expense-amount">0</div>
                    <div class="stat-label">üìâ Chiqim</div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">üìä Chiqimlar kategoriyalar bo'yicha</div>
                <div id="expense-chart"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">üìà Oylik tendensiya</div>
                <div id="trend-chart"></div>
            </div>
            
            <div class="transactions-list">
                <div class="transactions-title">üìã So'nggi tranzaksiyalar</div>
                <div id="transactions-list"></div>
            </div>
            
            <button class="refresh-btn" onclick="loadData()">üîÑ Yangilash</button>
        </div>
        
        <div id="error" class="error" style="display: none;">
            ‚ùå Ma'lumotlarni yuklashda xatolik yuz berdi
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // Foydalanuvchi ma'lumotlarini olish
        const user = tg.initDataUnsafe?.user;
        if (user) {
            console.log('Foydalanuvchi:', user);
        }
        
        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('content').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                
                // API dan ma'lumotlarni olish
                const response = await fetch('/api/reports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: user?.id,
                        init_data: tg.initData
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API xatolik');
                }
                
                const data = await response.json();
                
                // Ma'lumotlarni ko'rsatish
                displayData(data);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
            } catch (error) {
                console.error('Xatolik:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }
        
        function displayData(data) {
            // Balans
            document.getElementById('balance-amount').textContent = 
                formatNumber(data.balance) + ' so\'m';
            
            // Statistika
            document.getElementById('income-amount').textContent = 
                formatNumber(data.income) + ' so\'m';
            document.getElementById('expense-amount').textContent = 
                formatNumber(data.expense) + ' so\'m';
            
            // Chiqimlar grafigi
            if (data.expense_categories && Object.keys(data.expense_categories).length > 0) {
                createExpenseChart(data.expense_categories);
            }
            
            // Tendensiya grafigi
            if (data.monthly_trend && data.monthly_trend.length > 0) {
                createTrendChart(data.monthly_trend);
            }
            
            // Tranzaksiyalar ro'yxati
            displayTransactions(data.recent_transactions || []);
        }
        
        function createExpenseChart(categories) {
            const labels = Object.keys(categories);
            const values = Object.values(categories);
            
            const data = [{
                values: values,
                labels: labels,
                type: 'pie',
                marker: {
                    colors: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
                }
            }];
            
            const layout = {
                margin: { t: 0, b: 0, l: 0, r: 0 },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.1
                }
            };
            
            Plotly.newPlot('expense-chart', data, layout, {responsive: true});
        }
        
        function createTrendChart(trendData) {
            const dates = trendData.map(item => item.date);
            const income = trendData.map(item => item.income);
            const expense = trendData.map(item => item.expense);
            
            const data = [
                {
                    x: dates,
                    y: income,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Kirim',
                    line: { color: '#28a745' }
                },
                {
                    x: dates,
                    y: expense,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Chiqim',
                    line: { color: '#dc3545' }
                }
            ];
            
            const layout = {
                margin: { t: 20, b: 40, l: 40, r: 20 },
                xaxis: { title: 'Sana' },
                yaxis: { title: 'Summa (so\'m)' }
            };
            
            Plotly.newPlot('trend-chart', data, layout, {responsive: true});
        }
        
        function displayTransactions(transactions) {
            const container = document.getElementById('transactions-list');
            container.innerHTML = '';
            
            if (transactions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--tg-theme-hint-color); padding: 20px;">Hozircha tranzaksiyalar mavjud emas</div>';
                return;
            }
            
            transactions.forEach(transaction => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                
                const typeEmoji = {
                    'income': 'üìà',
                    'expense': 'üìâ',
                    'debt': 'üí≥'
                }[transaction.type] || '‚ùì';
                
                const amountClass = {
                    'income': 'amount-income',
                    'expense': 'amount-expense',
                    'debt': 'amount-debt'
                }[transaction.type] || '';
                
                item.innerHTML = `
                    <div class="transaction-info">
                        <div class="transaction-category">${typeEmoji} ${transaction.category}</div>
                        <div class="transaction-description">${transaction.description}</div>
                    </div>
                    <div class="transaction-amount ${amountClass}">${formatNumber(transaction.amount)} so'm</div>
                `;
                
                container.appendChild(item);
            });
        }
        
        function formatNumber(num) {
            return new Intl.NumberFormat('uz-UZ').format(num);
        }
        
        // Sahifani yuklash
        loadData();
    </script>
</body>
</html>
